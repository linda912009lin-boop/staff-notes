<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>éŸ³ç¬¦å¡ç‰Œé—–é—œï¼ˆå–®äººç‰ˆï½œäº”ç·šè­œï¼‰</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#6b7280; --accent:#111; --ok:#10b981; --border:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:linear-gradient(#fff,#fff0);padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:4px 0}
  .muted{color:var(--muted);font-size:13px}
  .hud{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .btn{padding:10px 14px;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;color:var(--accent)}
  .grid{display:grid;gap:12px;margin-top:16px}
  .grid.cols-8{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid.cols-10{grid-template-columns:repeat(5,minmax(0,1fr))}
  .grid.cols-12{grid-template-columns:repeat(6,minmax(0,1fr))}
  .grid.cols-14{grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.cols-16{grid-template-columns:repeat(8,minmax(0,1fr))}
  .grid.cols-20{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:8px;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;cursor:pointer;position:relative;transition:transform .08s ease}
  .card img{max-width:90%;max-height:90%;object-fit:contain;user-select:none;pointer-events:none}
  .card:active{transform:scale(.98)}
  .card.found{outline:3px solid var(--ok);box-shadow:0 0 0 3px #0000 inset;opacity:.88}
  .panel{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px}
  .big{font-size:28px;font-weight:800}
  .center{text-align:center}
  .hidden{display:none!important}
  footer{padding:16px;color:var(--muted);text-align:center}
  /* éŸ³æ•ˆæ§åˆ¶æ¢ */
  .audio-controls{display:flex;align-items:center;gap:8px}
  .audio-controls .btn{padding:8px 10px;border-radius:999px;font-size:14px}
  .audio-controls input[type="range"]{width:120px}
</style>
</head>
<body>
  <header>
    <div class="wrap hud">
      <div>
        <h1>éŸ³ç¬¦å¡ç‰Œé—–é—œï¼ˆå–®äººï¼‰</h1>
        <div class="muted">å…¨é—œå¡åƒ…ä½¿ç”¨äº”ç·šè­œåœ–ç‰‡ã€‚ç¿»å° +10 åˆ†ã€ç¿»éŒ¯ -5 åˆ†ã€‚æ‰¾åˆ°é¡Œç›®è¦æ±‚çš„æ‰€æœ‰å¡ç‰‡å³å¯éé—œã€‚</div>
      </div>
      <div class="pill">é—œå¡ <b id="levelNow">1</b> / <span id="levelTotal">10</span></div>
      <div class="pill">åˆ†æ•¸ <b id="score">0</b></div>
      <div class="pill">æ™‚é–“ <b id="time">00:00</b></div>
      <div class="pill audio-controls">
        <button id="toggleSfx" class="btn ghost" title="éŸ³æ•ˆé–‹é—œ">ğŸ”ˆ SFXï¼šé–‹</button>
        <button id="toggleBgm" class="btn ghost" title="èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾/æš«åœ">ğŸµ BGMï¼šé—œ</button>
        <label class="muted" for="bgmVol">éŸ³é‡</label>
        <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.4" />
      </div>
      <button id="btnRestart" class="btn ghost">é‡æ–°é–‹å§‹</button>
    </div>
  </header>

  <main class="wrap">
    <div id="goalPanel" class="panel">
      <div><b>é¡Œç›®ï¼š</b><span id="goalText">ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºDoçš„éŸ³ç¬¦ã€ã€‚</span></div>
    </div>

    <div id="grid" class="grid cols-8"></div>

    <div id="result" class="panel center hidden">
      <div class="big">æ­å–œéé—œï¼</div>
      <div style="margin-top:8px">é—œå¡ <span id="rLevel"></span> / <span id="rTotal"></span></div>
      <div style="margin-top:8px">æœ¬é—œç”¨æ™‚ <b id="rTime"></b>ï¼ç²å¾—åˆ†æ•¸ <b id="rScore"></b></div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
        <button id="btnNext" class="btn">ä¸‹ä¸€é—œ</button>
        <button id="btnAgain" class="btn ghost">é‡ç©æœ¬é—œ</button>
      </div>
    </div>

    <div id="gameover" class="panel center hidden">
      <div class="big">å…¨éƒ¨é€šé—œï¼</div>
      <div style="margin-top:8px">ç¸½ç”¨æ™‚ <b id="goTime"></b>ï¼ç¸½åˆ† <b id="goScore"></b></div>
      <div style="margin-top:12px">
        <button id="btnRestart2" class="btn">é‡æ–°é–‹å§‹</button>
      </div>
    </div>
  </main>

  <footer>Â© 2025 å¡ç‰ŒéŸ³ç¬¦é—–é—œï¼ˆå–®äººï½œäº”ç·šè­œï¼‰</footer>

<script>
/* ========= å¯èª¿æ•´è¨­å®š ========= */
const CONFIG = {
  pointsCorrect: 10,
  pointsWrong: -5,
  clearBonusPerSec: 2,   // é€šé—œï¼šæ¯å‰©é¤˜ 1 ç§’åŠ å¹¾åˆ†
  minTargetsRatio: 0.4,  // å¡å †ä¸­ç›®æ¨™å¡æ¯”ä¾‹ä¸‹é™
};
/* ç‰Œæ•¸ / å€’æ•¸ç§’æ•¸ / é¡Œç›® */
const LEVELS = [
  { cards:  8, timeSec:  50, target:'Do',  label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºDoçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 10, timeSec:  60, target:'F',   label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºï¼¦çš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 12, timeSec:  70, target:'Sol', label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºSolçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 12, timeSec:  70, target:'A',   label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºAçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 14, timeSec:  80, target:'Si',  label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºSiçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 14, timeSec:  80, target:'D',   label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºDçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 16, timeSec:  90, target:'Mi',  label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºMiçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 16, timeSec:  90, target:'Fa',  label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºFaçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 20, timeSec: 100, target:'La',  label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºLaçš„éŸ³ç¬¦ã€ã€‚' },
  { cards: 20, timeSec: 110, target:'C',   label:'ã€è«‹æ‰¾å‡ºä¸‹åˆ—ç‚ºCçš„éŸ³ç¬¦ã€ã€‚' },
];

/* ========= åœ–ç‰‡èˆ‡åç¨±å°æ‡‰ï¼ˆæª”åéœ€é€å­—ä¸€è‡´ï¼‰ ========= */
const IMG_DIR = './images/';
const NOTE_MAP = {
  do:  ['é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdoäº”ç·šè­œ.png','ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdoäº”ç·šè­œ.png'],
  re:  ['é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“reäº”ç·šè­œ.png'],
  mi:  ['é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmiäº”ç·šè­œ.png'],
  fa:  ['é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“faäº”ç·šè­œ.png','ä½éŸ³è­œè™Ÿç¬¬å››ç·šfaäº”ç·šè­œ.png'],
  sol: ['é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsoläº”ç·šè­œ.png','ä½éŸ³è­œè™Ÿç¬¬å››é–“soläº”ç·šè­œ.png'],
  la:  ['ä½éŸ³è­œè™Ÿç¬¬äº”ç·šlaäº”ç·šè­œ.png'],
  si:  ['ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“siäº”ç·šè­œ.png'],
};
const ALIAS = {
  c:'do', d:'re', e:'mi', f:'fa', g:'sol', a:'la', b:'si',
  C:'do', D:'re', E:'mi', F:'fa', G:'sol', A:'la', B:'si',
  Do:'do', Re:'re', Mi:'mi', Fa:'fa', Sol:'sol', La:'la', Si:'si'
};

/* ========= å°å·¥å…· ========= */
const $ = s=>document.querySelector(s);
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function pad(n){ return String(n).padStart(2,'0') }
function fmt(ms){ const s=Math.max(0, Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${pad(m)}:${pad(r)}` }
function imagesFor(noteKey){ const k = NOTE_MAP[noteKey] ? noteKey : (ALIAS[noteKey] || null); return k ? NOTE_MAP[k] : null; }

/* ========= éŸ³æ•ˆèˆ‡èƒŒæ™¯éŸ³æ¨‚ ========= */
const SND_DIR = './sounds/';
const sounds = {
  correct: new Audio(SND_DIR + 'correct.mp3'),
  wrong:   new Audio(SND_DIR + 'wrong.mp3'),
  clear:   new Audio(SND_DIR + 'clear.mp3'),
  tick:    new Audio(SND_DIR + 'tick.mp3'),
};
function playSfx(name){
  if(!state.sfxOn) return;
  const a = sounds[name];
  if(!a) return;
  const n = a.cloneNode(); // å…è¨±é€£æ’­
  n.volume = 0.9;
  n.play().catch(()=>{ /* é¦–æ¬¡æœªäº’å‹•å¯èƒ½è¢«é˜»æ“‹ */ });
}
// èƒŒæ™¯éŸ³æ¨‚ï¼ˆé è¨­é—œï¼Œéœ€é»æŒ‰éˆ•é–‹ï¼‰
const bgm = new Audio(SND_DIR + 'bgm.mp3');
bgm.loop = true;
bgm.volume = 0.4;

/* ========= ç‹€æ…‹ ========= */
const levelTotal = LEVELS.length;
let lastBeepSec = null;
let state = {
  level: 1,
  score: 0,
  timerId: null,
  levelLimitMs: 0,
  startedAt: 0,
  isTimeout: false,
  totalElapsedMs: 0,
  sfxOn: true,
  bgmOn: false,
};
$('#levelTotal').textContent = levelTotal;

/* ========= å€’æ•¸è¨ˆæ™‚ ========= */
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }
function startCountdown(sec){
  stopTimer();
  state.levelLimitMs = sec * 1000;
  state.startedAt = Date.now();
  state.isTimeout = false;
  lastBeepSec = null;
  $('#time').textContent = fmt(state.levelLimitMs);

  state.timerId = setInterval(()=>{
    const elapsed = Date.now() - state.startedAt;
    const left = Math.max(0, state.levelLimitMs - elapsed);
    $('#time').textContent = fmt(left);

    // æœ€å¾Œ 5 ç§’å—¶è²
    const leftSec = Math.ceil(left/1000);
    if (leftSec <= 5 && leftSec !== lastBeepSec && left > 0){
      playSfx('tick');
      lastBeepSec = leftSec;
    }

    if(left <= 0){
      stopTimer();
      state.isTimeout = true;
      onTimeout();
    }
  }, 200);
}

/* ========= ç”¢ç”Ÿå¡ç‰‡ ========= */
function buildDeck(cfg){
  const tgtImgs = imagesFor(cfg.target);
  if(!tgtImgs || tgtImgs.length===0){ alert('æ‰¾ä¸åˆ°ç›®æ¨™éŸ³ç¬¦åœ–ç‰‡ï¼š'+cfg.target); return []; }

  const noteKeys = Object.keys(NOTE_MAP);
  const distractPool = noteKeys.filter(k => k !== (ALIAS[cfg.target]||cfg.target));

  const deck = [];
  const targetCount = Math.max(Math.floor(cfg.cards * CONFIG.minTargetsRatio), 2);
  for(let i=0;i<targetCount;i++){ deck.push({ isTarget:true, src: rand(tgtImgs) }); }
  while(deck.length < cfg.cards){
    const note = rand(distractPool);
    const imgs = NOTE_MAP[note];
    if(!imgs || !imgs.length) continue;
    deck.push({ isTarget:false, src: rand(imgs) });
  }
  return shuffle(deck);
}

/* ========= æ¸²æŸ“èˆ‡äº’å‹• ========= */
const grid = $('#grid');
function renderGoal(cfg){ $('#goalText').textContent = cfg.label; }
function renderGrid(deck){
  grid.className = `grid cols-${deck.length}`;
  grid.innerHTML = '';

  deck.forEach((card,idx)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.idx = idx;
    el.dataset.target = card.isTarget ? '1' : '0';

    const img = document.createElement('img');
    img.alt = card.isTarget ? 'target' : 'distractor';

    // åŸå§‹æª”åï¼›å¤±æ•—å‰‡ç”¨ URL ç·¨ç¢¼é‡è©¦
    img.src = IMG_DIR + card.src;
    img.onerror = () => {
      if (!img.dataset.retry) {
        img.dataset.retry = '1';
        img.src = IMG_DIR + encodeURIComponent(card.src);
      } else {
        el.style.outline = '2px dashed #f59e0b';
      }
    };

    el.appendChild(img);
    el.addEventListener('click', ()=> onCardClick(el));
    grid.appendChild(el);
  });
}
function scoreDelta(d){ state.score = Math.max(0, state.score + d); $('#score').textContent = state.score; }
function onCardClick(el){
  if(state.isTimeout || el.classList.contains('found')) return;
  const isTarget = el.dataset.target==='1';
  if(isTarget){
    playSfx('correct');
    el.classList.add('found');
    scoreDelta(CONFIG.pointsCorrect);
    checkLevelClear();
  }else{
    playSfx('wrong');
    el.animate([{transform:'translateY(0)'},{transform:'translateY(3px)'},{transform:'translateY(0)'}], {duration:120});
    scoreDelta(CONFIG.pointsWrong);
  }
}
function checkLevelClear(){
  const remain = [...grid.children].filter(c=>c.dataset.target==='1' && !c.classList.contains('found'));
  if(remain.length===0){
    const elapsed = Date.now() - state.startedAt;
    const leftMs  = Math.max(0, state.levelLimitMs - elapsed);
    const bonus   = Math.floor(leftMs/1000) * CONFIG.clearBonusPerSec;

    stopTimer();
    state.totalElapsedMs += Math.min(elapsed, state.levelLimitMs);
    if(bonus) scoreDelta(bonus);
    playSfx('clear');

    showResult({ title:'æ­å–œéé—œï¼', canNext:true, elapsedMs:elapsed, bonus });
  }
}

/* ========= çµæœ / è¶…æ™‚ ========= */
function showResult({title, canNext, elapsedMs, bonus=0}){
  $('#rLevel').textContent = state.level;
  $('#rTotal').textContent = levelTotal;
  $('#rTime').textContent  = fmt(elapsedMs);
  $('#rScore').textContent = state.score;

  document.querySelector('#result .big').textContent = title;
  document.getElementById('btnNext').style.display = canNext ? 'inline-block' : 'none';

  if(bonus){
    const timeLine = document.getElementById('rTime').parentElement;
    timeLine.innerHTML = `æœ¬é—œç”¨æ™‚ <b id="rTime">${fmt(elapsedMs)}</b>ï¼ç²å¾—åˆ†æ•¸ <b id="rScore">${state.score}</b>ï¼ˆå«å‰©é¤˜ç§’æ•¸çå‹µ +${bonus}ï¼‰`;
  }

  document.getElementById('result').classList.remove('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  grid.classList.add('hidden');
}
function onTimeout(){
  showResult({ title:'æ™‚é–“åˆ°ï¼', canNext:false, elapsedMs: state.levelLimitMs });
}

/* ========= é—œå¡æ§åˆ¶ ========= */
function startLevel(n){
  if(n<1) n=1;
  if(n>levelTotal){ return showGameOver(); }

  document.getElementById('result').classList.add('hidden');
  document.getElementById('gameover').classList.add('hidden');
  document.getElementById('goalPanel').classList.remove('hidden');
  grid.classList.remove('hidden');

  state.isTimeout = false;
  document.getElementById('levelNow').textContent = String(n);

  state.level = n;
  const cfg = LEVELS[n-1];
  renderGoal(cfg);
  renderGrid(buildDeck(cfg));
  startCountdown(cfg.timeSec);
}
function nextLevel(){
  if(state.isTimeout) return;
  if(state.level >= levelTotal){ showGameOver(); }
  else { startLevel(state.level + 1); }
}
function showGameOver(){
  stopTimer();
  grid.classList.add('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  document.getElementById('gameover').classList.remove('hidden');
  document.getElementById('goTime').textContent = fmt(state.totalElapsedMs);
  document.getElementById('goScore').textContent = state.score;
}
function restartAll(){
  stopTimer();
  state = { level:1, score:0, timerId:null, levelLimitMs:0, startedAt:0, isTimeout:false, totalElapsedMs:0, sfxOn: state.sfxOn, bgmOn: state.bgmOn };
  document.getElementById('score').textContent = '0';
  document.getElementById('time').textContent  = '00:00';
  startLevel(1);
}

/* ========= éŸ³æ•ˆ UI äº‹ä»¶ ========= */
const btnSfx = document.getElementById('toggleSfx');
const btnBgm = document.getElementById('toggleBgm');
const volBgm = document.getElementById('bgmVol');

btnSfx.addEventListener('click', ()=>{
  state.sfxOn = !state.sfxOn;
  btnSfx.textContent = state.sfxOn ? 'ğŸ”ˆ SFXï¼šé–‹' : 'ğŸ”‡ SFXï¼šé—œ';
});

btnBgm.addEventListener('click', async ()=>{
  state.bgmOn = !state.bgmOn;
  btnBgm.textContent = state.bgmOn ? 'ğŸµ BGMï¼šé–‹' : 'ğŸµ BGMï¼šé—œ';
  try{
    if(state.bgmOn){
      bgm.volume = parseFloat(volBgm.value || '0.4');
      await bgm.play();
    }else{
      bgm.pause();
    }
  }catch(e){
    // è‹¥è¢«è‡ªå‹•æ’­æ”¾ç­–ç•¥æ“‹ä½ï¼Œæç¤ºä½¿ç”¨è€…å†é»ä¸€æ¬¡
    console.warn('BGM play blocked until user gesture', e);
  }
});
volBgm.addEventListener('input', ()=>{
  bgm.volume = parseFloat(volBgm.value || '0.4');
});

/* ========= å•Ÿå‹• ========= */
startLevel(1);
</script>
</body>
</html>
