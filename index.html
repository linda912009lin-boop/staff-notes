<script>
/* ====== 可調整設定 ====== */
const CONFIG = {
  pointsCorrect: 10,       // 翻對加分
  pointsWrong: -5,         // 翻錯扣分
  clearBonusPerSec: 2,     // 通關：每剩餘1秒加幾分
  minTargetsRatio: 0.4,    // 牌堆中目標卡比例下限
};
/* 每關設定：cards = 牌數、timeSec = 倒數秒數、target = 要找的音符（Do/F/Sol...） */
const LEVELS = [
  { cards:  8, timeSec:  50, target:'Do',  label:'『請找出下列為Do的音符』。' },
  { cards: 10, timeSec:  60, target:'F',   label:'『請找出下列為Ｆ的音符』。' },
  { cards: 12, timeSec:  70, target:'Sol', label:'『請找出下列為Sol的音符』。' },
  { cards: 12, timeSec:  70, target:'A',   label:'『請找出下列為A的音符』。' },
  { cards: 14, timeSec:  80, target:'Si',  label:'『請找出下列為Si的音符』。' },
  { cards: 14, timeSec:  80, target:'D',   label:'『請找出下列為D的音符』。' },
  { cards: 16, timeSec:  90, target:'Mi',  label:'『請找出下列為Mi的音符』。' },
  { cards: 16, timeSec:  90, target:'Fa',  label:'『請找出下列為Fa的音符』。' },
  { cards: 20, timeSec: 100, target:'La',  label:'『請找出下列為La的音符』。' },
  { cards: 20, timeSec: 110, target:'C',   label:'『請找出下列為C的音符』。' },
];

/* ====== 圖片根目錄與檔名對應 ====== */
const IMG_DIR = './images/';
const NOTE_MAP = {
  do:  ['高音譜號下加一線do五線譜.png','低音譜號上加一線do五線譜.png'],
  re:  ['高音譜號下一間re五線譜.png'],
  mi:  ['高音譜號第一線mi五線譜.png'],
  fa:  ['高音譜號第一間fa五線譜.png','低音譜號第四線fa五線譜.png'],
  // 你更新後的檔名（sol 的低音改為「第四間」）
  sol: ['高音譜號第二線sol五線譜.png','低音譜號第四間sol五線譜.png'],
  la:  ['低音譜號第五線la五線譜.png'],
  // 你更新後的檔名（si）
  si:  ['低音譜號上加一間si五線譜.png'],
};
const ALIAS = {
  c:'do', d:'re', e:'mi', f:'fa', g:'sol', a:'la', b:'si',
  C:'do', D:'re', E:'mi', F:'fa', G:'sol', A:'la', B:'si',
  Do:'do', Re:'re', Mi:'mi', Fa:'fa', Sol:'sol', La:'la', Si:'si'
};

/* ====== 小工具 ====== */
const $ = s=>document.querySelector(s);
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function pad(n){ return String(n).padStart(2,'0') }
function fmt(ms){ const s=Math.max(0, Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${pad(m)}:${pad(r)}` }
function imagesFor(noteKey){ const k = NOTE_MAP[noteKey] ? noteKey : (ALIAS[noteKey] || null); return k ? NOTE_MAP[k] : null; }

/* ====== 狀態 ====== */
const levelTotal = LEVELS.length;
let state = {
  level: 1,
  score: 0,
  timerId: null,
  levelLimitMs: 0,    // 本關總秒數（毫秒）
  startedAt: 0,       // 本關開始時間
  isTimeout: false,
  totalElapsedMs: 0,  // 全部通關用時累計（只計成功關卡）
};
$('#levelTotal').textContent = levelTotal;

/* ====== 計時（倒數） ====== */
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }
function startCountdown(sec){
  stopTimer();
  state.levelLimitMs = sec * 1000;
  state.startedAt = Date.now();
  state.isTimeout = false;
  $('#time').textContent = fmt(state.levelLimitMs);

  state.timerId = setInterval(()=>{
    const elapsed = Date.now() - state.startedAt;
    const left = Math.max(0, state.levelLimitMs - elapsed);
    $('#time').textContent = fmt(left);
    if(left <= 0){
      stopTimer();
      state.isTimeout = true;
      onTimeout();
    }
  }, 200);
}

/* ====== 產生卡片 ====== */
function buildDeck(cfg){
  const tgtImgs = imagesFor(cfg.target);
  if(!tgtImgs || tgtImgs.length===0){ alert('找不到目標音符圖片：'+cfg.target); return []; }

  const noteKeys = Object.keys(NOTE_MAP);
  const distractPool = noteKeys.filter(k => k !== (ALIAS[cfg.target]||cfg.target));

  const deck = [];
  const targetCount = Math.max(Math.floor(cfg.cards * CONFIG.minTargetsRatio), 2);
  for(let i=0;i<targetCount;i++){ deck.push({ isTarget:true, src: rand(tgtImgs) }); }
  while(deck.length < cfg.cards){
    const note = rand(distractPool);
    const imgs = NOTE_MAP[note];
    if(!imgs || !imgs.length) continue;
    deck.push({ isTarget:false, src: rand(imgs) });
  }
  return shuffle(deck);
}

/* ====== 渲染與互動 ====== */
const grid = $('#grid');
function renderGoal(cfg){ $('#goalText').textContent = cfg.label; }
function renderGrid(deck){
  function renderGrid(deck){
  grid.className = `grid cols-${deck.length}`;
  grid.innerHTML = '';

  deck.forEach((card,idx)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.idx = idx;
    el.dataset.target = card.isTarget ? '1' : '0';

    const img = document.createElement('img');
    img.alt = card.isTarget ? 'target' : 'distractor';

    // 第一次用原始檔名
    img.src = IMG_DIR + card.src;

    // 若失敗 → 再用 URL 編碼後的檔名嘗試一次
    img.onerror = () => {
      if (!img.dataset.retry) {
        img.dataset.retry = '1';
        img.src = IMG_DIR + encodeURIComponent(card.src);
      } else {
        // 兩次都失敗 → 做醒目標記，方便排查
        el.style.outline = '2px dashed #f59e0b';
      }
    };

    el.appendChild(img);
    el.addEventListener('click', ()=> onCardClick(el));
    grid.appendChild(el);
  });
}

function scoreDelta(d){ state.score = Math.max(0, state.score + d); $('#score').textContent = state.score; }

function onCardClick(el){
  if(state.isTimeout || el.classList.contains('found')) return;
  const isTarget = el.dataset.target==='1';
  if(isTarget){
    el.classList.add('found');
    scoreDelta(CONFIG.pointsCorrect);
    checkLevelClear();
  }else{
    el.animate([{transform:'translateY(0)'},{transform:'translateY(3px)'},{transform:'translateY(0)'}], {duration:120});
    scoreDelta(CONFIG.pointsWrong);
  }
}

function checkLevelClear(){
  const remain = [...grid.children].filter(c=>c.dataset.target==='1' && !c.classList.contains('found'));
  if(remain.length===0){
    const elapsed = Date.now() - state.startedAt;
    const leftMs  = Math.max(0, state.levelLimitMs - elapsed);
    const bonus   = Math.floor(leftMs/1000) * CONFIG.clearBonusPerSec;

    stopTimer();
    state.totalElapsedMs += Math.min(elapsed, state.levelLimitMs);
    if(bonus) scoreDelta(bonus);

    showResult({
      title: '恭喜過關！',
      canNext: true,
      elapsedMs: elapsed,
      bonus
    });
  }
}

/* ====== 結果 / 超時 ====== */
function showResult({title, canNext, elapsedMs, bonus=0}){
  $('#rLevel').textContent = state.level;
  $('#rTotal').textContent = levelTotal;
  $('#rTime').textContent  = fmt(elapsedMs);
  $('#rScore').textContent = state.score;

  // 動態改標題
  document.querySelector('#result .big').textContent = title;

  // 顯示或隱藏「下一關」按鈕
  const btnNext = document.getElementById('btnNext');
  btnNext.style.display = canNext ? 'inline-block' : 'none';

  // 額外在時間行後面附註獎勵（不改 HTML 結構，直接附加在 goalPanel 下方）
  if(bonus){
    // 在結果面板下方添加一行提示（簡單做法：修改本關用時那行的文字）
    const timeLine = document.getElementById('rTime').parentElement;
    timeLine.innerHTML = `本關用時 <b id="rTime">${fmt(elapsedMs)}</b>．獲得分數 <b id="rScore">${state.score}</b>（含剩餘秒數獎勵 +${bonus}）`;
  }

  document.getElementById('result').classList.remove('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  grid.classList.toggle('hidden', true);
}
function onTimeout(){
  showResult({
    title: '時間到！',
    canNext: false,
    elapsedMs: state.levelLimitMs
  });
}

/* ====== 關卡控制 ====== */
function startLevel(n){
  if(n<1) n=1;
  if(n>levelTotal){ return showGameOver(); }

  // reset panels
  document.getElementById('result').classList.add('hidden');
  document.getElementById('gameover').classList.add('hidden');
  document.getElementById('goalPanel').classList.remove('hidden');
  grid.classList.remove('hidden');

  // reset HUD
  state.isTimeout = false;
  document.getElementById('levelNow').textContent = String(n);

  // build
  state.level = n;
  const cfg = LEVELS[n-1];
  renderGoal(cfg);
  const deck = buildDeck(cfg);
  renderGrid(deck);

  // timer
  startCountdown(cfg.timeSec);
}
function nextLevel(){
  if(state.isTimeout) return;  // 超時不能下一關
  if(state.level >= levelTotal){ showGameOver(); }
  else { startLevel(state.level + 1); }
}
function showGameOver(){
  stopTimer();
  grid.classList.add('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  document.getElementById('gameover').classList.remove('hidden');
  document.getElementById('goTime').textContent = fmt(state.totalElapsedMs);
  document.getElementById('goScore').textContent = state.score;
}
function restartAll(){
  stopTimer();
  state = { level:1, score:0, timerId:null, levelLimitMs:0, startedAt:0, isTimeout:false, totalElapsedMs:0 };
  document.getElementById('score').textContent = '0';
  document.getElementById('time').textContent  = '00:00';
  startLevel(1);
}

/* ====== 事件 ====== */
document.getElementById('btnRestart').addEventListener('click', restartAll);
document.addEventListener('click', e=>{
  if(e.target.id==='btnNext') nextLevel();
  if(e.target.id==='btnAgain') startLevel(state.level);
  if(e.target.id==='btnRestart2') restartAll();
});

/* ====== 啟動 ====== */
startLevel(1);
</script>
