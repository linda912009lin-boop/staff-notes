<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>音符卡牌闖關（單人版｜五線譜）</title>
<style>
  :root{ --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#6b7280; --accent:#111; --ok:#10b981; --border:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:linear-gradient(#fff,#fff0);padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:4px 0}
  .muted{color:var(--muted);font-size:13px}
  .hud{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .btn{padding:10px 14px;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;color:var(--accent)}
  .grid{display:grid;gap:12px;margin-top:16px}
  .grid.cols-8{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid.cols-10{grid-template-columns:repeat(5,minmax(0,1fr))}
  .grid.cols-12{grid-template-columns:repeat(6,minmax(0,1fr))}
  .grid.cols-14{grid-template-columns:repeat(7,minmax(0,1fr))}
  .grid.cols-16{grid-template-columns:repeat(8,minmax(0,1fr))}
  .grid.cols-20{grid-template-columns:repeat(5,minmax(0,1fr))}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:8px;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;cursor:pointer;position:relative;transition:transform .08s ease}
  .card img{max-width:90%;max-height:90%;object-fit:contain;user-select:none;pointer-events:none}
  .card:active{transform:scale(.98)}
  .card.found{outline:3px solid var(--ok);box-shadow:0 0 0 3px #0000 inset;opacity:.88}
  .panel{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px}
  .big{font-size:28px;font-weight:800}
  .center{text-align:center}
  .hidden{display:none!important}
  footer{padding:16px;color:var(--muted);text-align:center}

  /* 音效控制與混音器 */
  .audio-controls{display:flex;align-items:center;gap:8px}
  .audio-controls .btn{padding:8px 10px;border-radius:999px;font-size:14px}
  .audio-controls input[type="range"]{width:120px}
  #mixer .mix-row{ display:flex; align-items:center; gap:10px; margin:8px 0; }
  #mixer .mix-row label{ width:160px; }
  #mixer .mix-row input[type="range"]{ width:220px; }
  #mixer .mix-row span{ min-width:48px; text-align:right; color:var(--muted); }
</style>
</head>
<body>
  <header>
    <div class="wrap hud">
      <div>
        <h1>音符卡牌闖關（單人）</h1>
        <div class="muted">全關卡僅使用五線譜圖片。翻對 +10 分、翻錯 -5 分。找到題目要求的所有卡片即可過關。</div>
      </div>
      <div class="pill">關卡 <b id="levelNow">1</b> / <span id="levelTotal">10</span></div>
      <div class="pill">分數 <b id="score">0</b></div>
      <div class="pill">時間 <b id="time">00:00</b></div>
      <div class="pill audio-controls">
        <button id="toggleSfx" class="btn ghost" title="音效開關">🔈 SFX：開</button>
        <button id="toggleBgm" class="btn ghost" title="背景音樂播放/暫停">🎵 BGM：關</button>
        <label class="muted" for="bgmVol">音量</label>
        <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.4" />
        <button id="btnMixer" class="btn ghost" title="調整音量">🎚️ 調整音量</button>
      </div>
      <button id="btnRestart" class="btn ghost">重新開始</button>
    </div>
  </header>

  <main class="wrap">
    <div id="goalPanel" class="panel">
      <div><b>題目：</b><span id="goalText">『請找出下列為Do的音符』。</span></div>
    </div>

    <div id="grid" class="grid cols-8"></div>

    <div id="result" class="panel center hidden">
      <div class="big">恭喜過關！</div>
      <div style="margin-top:8px">關卡 <span id="rLevel"></span> / <span id="rTotal"></span></div>
      <div style="margin-top:8px">本關用時 <b id="rTime"></b>．獲得分數 <b id="rScore"></b></div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
        <button id="btnNext" class="btn">下一關</button>
        <button id="btnAgain" class="btn ghost">重玩本關</button>
      </div>
    </div>

    <div id="gameover" class="panel center hidden">
      <div class="big">全部通關！</div>
      <div style="margin-top:8px">總用時 <b id="goTime"></b>．總分 <b id="goScore"></b></div>
      <div style="margin-top:12px">
        <button id="btnRestart2" class="btn">重新開始</button>
      </div>
    </div>

    <!-- 音量混音器 -->
    <div id="mixer" class="panel hidden">
      <b>音量混音器</b>
      <div class="muted" style="margin:6px 0 10px">調整各音效與背景音樂的相對音量（會自動記住）。</div>
      <div class="mix-row"><label>總音量</label><input id="vol-master" type="range" min="0" max="1.5" step="0.01"><span id="pct-master"></span></div>
      <div class="mix-row"><label>✔️ 正確（correct）</label><input id="vol-correct" type="range" min="0" max="1.5" step="0.01"><span id="pct-correct"></span></div>
      <div class="mix-row"><label>❌ 錯誤（wrong）</label>  <input id="vol-wrong"   type="range" min="0" max="1.5" step="0.01"><span id="pct-wrong"></span></div>
      <div class="mix-row"><label>🎉 過關（clear）</label>  <input id="vol-clear"   type="range" min="0" max="1.5" step="0.01"><span id="pct-clear"></span></div>
      <div class="mix-row"><label>⏳ 倒數嗶（tick）</label><input id="vol-tick"    type="range" min="0" max="1.5" step="0.01"><span id="pct-tick"></span></div>
      <div class="mix-row"><label>🎵 背景音樂（bgm）</label><input id="vol-bgm"     type="range" min="0" max="1.5" step="0.01"><span id="pct-bgm"></span></div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button id="btnTestAll" class="btn">測試全部音效</button>
        <button id="btnResetVol" class="btn ghost">還原預設</button>
        <button id="btnCloseMixer" class="btn ghost">關閉</button>
      </div>
    </div>
  </main>

  <footer>© 2025 卡牌音符闖關（單人｜五線譜）</footer>

<script>
/* ========= 可調整設定 ========= */
const CONFIG = {
  pointsCorrect: 10,
  pointsWrong: -5,
  clearBonusPerSec: 2,   // 通關：每剩餘 1 秒加幾分
  minTargetsRatio: 0.4,  // 卡堆中目標卡比例下限
};
/* 牌數 / 倒數秒數 / 題目 */
const LEVELS = [
  { cards:  8, timeSec:  50, target:'Do',  label:'『請找出下列為Do的音符』。' },
  { cards: 10, timeSec:  60, target:'F',   label:'『請找出下列為Ｆ的音符』。' },
  { cards: 12, timeSec:  70, target:'Sol', label:'『請找出下列為Sol的音符』。' },
  { cards: 12, timeSec:  70, target:'A',   label:'『請找出下列為A的音符』。' },
  { cards: 14, timeSec:  80, target:'Si',  label:'『請找出下列為Si的音符』。' },
  { cards: 14, timeSec:  80, target:'D',   label:'『請找出下列為D的音符』。' },
  { cards: 16, timeSec:  90, target:'Mi',  label:'『請找出下列為Mi的音符』。' },
  { cards: 16, timeSec:  90, target:'Fa',  label:'『請找出下列為Fa的音符』。' },
  { cards: 20, timeSec: 100, target:'La',  label:'『請找出下列為La的音符』。' },
  { cards: 20, timeSec: 110, target:'C',   label:'『請找出下列為C的音符』。' },
];

/* ========= 圖片與名稱對應（檔名需逐字一致） ========= */
const IMG_DIR = './images/';
const NOTE_MAP = {
  do:  ['高音譜號下加一線do五線譜.png','低音譜號上加一線do五線譜.png'],
  re:  ['高音譜號下一間re五線譜.png'],
  mi:  ['高音譜號第一線mi五線譜.png'],
  fa:  ['高音譜號第一間fa五線譜.png','低音譜號第四線fa五線譜.png'],
  sol: ['高音譜號第二線sol五線譜.png','低音譜號第四間sol五線譜.png'],
  la:  ['低音譜號第五線la五線譜.png'],
  si:  ['低音譜號上加一間si五線譜.png'],
};
const ALIAS = {
  c:'do', d:'re', e:'mi', f:'fa', g:'sol', a:'la', b:'si',
  C:'do', D:'re', E:'mi', F:'fa', G:'sol', A:'la', B:'si',
  Do:'do', Re:'re', Mi:'mi', Fa:'fa', Sol:'sol', La:'la', Si:'si'
};

/* ========= 小工具 ========= */
const $ = s=>document.querySelector(s);
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function pad(n){ return String(n).padStart(2,'0') }
function fmt(ms){ const s=Math.max(0, Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${pad(m)}:${pad(r)}` }
function imagesFor(noteKey){ const k = NOTE_MAP[noteKey] ? noteKey : (ALIAS[noteKey] || null); return k ? NOTE_MAP[k] : null; }

/* ========= 音效與背景音樂（含音量混音器） ========= */
const SND_DIR = './sounds/';
const sounds = {
  correct: new Audio(SND_DIR + 'correct.mp3'),
  wrong:   new Audio(SND_DIR + 'wrong.mp3'),
  clear:   new Audio(SND_DIR + 'clear.mp3'),
  tick:    new Audio(SND_DIR + 'tick.mp3'),
};
// 基礎音量（程式層校正），再乘上使用者調整＆總音量
const BASE_VOL = { correct: 0.8, wrong: 0.45, clear: 0.8, tick: 0.25, bgm: 0.4, master: 1.0 };
// 使用者自訂（0~1.5），存在 localStorage
const DEFAULT_VOL = { master:1, correct:1, wrong:1, clear:1, tick:1, bgm:1 };
let VOL = (()=> { try { return { ...DEFAULT_VOL, ...(JSON.parse(localStorage.getItem('sfxVol')||'{}')) }; } catch { return { ...DEFAULT_VOL }; } })();
function saveVOL(){ localStorage.setItem('sfxVol', JSON.stringify(VOL)); }

function playSfx(name){
  if(!state.sfxOn) return;
  const a = sounds[name]; if(!a) return;
  const vol = (BASE_VOL[name] ?? 0.8) * (VOL[name] ?? 1) * (VOL.master ?? 1);

  // tick：避免疊聲 → 每次先停、歸零，再播（不 clone）
  if(name === 'tick'){
    try { a.pause(); a.currentTime = 0; a.volume = vol; a.play(); } catch(e){}
    return;
  }
  // 其他允許連播 → clone
  const n = a.cloneNode(); n.volume = vol;
  n.play().catch(()=>{});
}

// 背景音樂（預設關）
const bgm = new Audio(SND_DIR + 'bgm.mp3');
bgm.loop = true;
function applyBgmVolume(){ bgm.volume = (BASE_VOL.bgm * (VOL.bgm ?? 1) * (VOL.master ?? 1)); }
applyBgmVolume();

/* ========= 狀態 ========= */
const levelTotal = LEVELS.length;
let lastBeepSec = null;
let state = {
  level: 1,
  score: 0,
  timerId: null,
  levelLimitMs: 0,
  startedAt: 0,
  isTimeout: false,
  totalElapsedMs: 0,
  sfxOn: true,
  bgmOn: false,
};
$('#levelTotal').textContent = levelTotal;

/* ========= 倒數計時 ========= */
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }
function startCountdown(sec){
  stopTimer();
  state.levelLimitMs = sec * 1000;
  state.startedAt = Date.now();
  state.isTimeout = false;
  lastBeepSec = null;
  $('#time').textContent = fmt(state.levelLimitMs);

  state.timerId = setInterval(()=>{
    const elapsed = Date.now() - state.startedAt;
    const left = Math.max(0, state.levelLimitMs - elapsed);
    $('#time').textContent = fmt(left);

    // 最後 5 秒嗶聲（不疊聲）
    const leftSec = Math.ceil(left/1000);
    if (leftSec <= 5 && leftSec !== lastBeepSec && left > 0){
      playSfx('tick');
      lastBeepSec = leftSec;
    }

    if(left <= 0){
      stopTimer();
      state.isTimeout = true;
      onTimeout();
    }
  }, 200);
}

/* ========= 產生卡片 ========= */
function buildDeck(cfg){
  const tgtImgs = imagesFor(cfg.target);
  if(!tgtImgs || tgtImgs.length===0){ alert('找不到目標音符圖片：'+cfg.target); return []; }

  const noteKeys = Object.keys(NOTE_MAP);
  const distractPool = noteKeys.filter(k => k !== (ALIAS[cfg.target]||cfg.target));

  const deck = [];
  const targetCount = Math.max(Math.floor(cfg.cards * CONFIG.minTargetsRatio), 2);
  for(let i=0;i<targetCount;i++){ deck.push({ isTarget:true, src: rand(tgtImgs) }); }
  while(deck.length < cfg.cards){
    const note = rand(distractPool);
    const imgs = NOTE_MAP[note];
    if(!imgs || !imgs.length) continue;
    deck.push({ isTarget:false, src: rand(imgs) });
  }
  return shuffle(deck);
}

/* ========= 渲染與互動 ========= */
const grid = $('#grid');
function renderGoal(cfg){ $('#goalText').textContent = cfg.label; }
function renderGrid(deck){
  grid.className = `grid cols-${deck.length}`;
  grid.innerHTML = '';

  deck.forEach((card,idx)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.idx = idx;
    el.dataset.target = card.isTarget ? '1' : '0';

    const img = document.createElement('img');
    img.alt = card.isTarget ? 'target' : 'distractor';

    // 原始檔名；失敗則用 URL 編碼重試
    img.src = IMG_DIR + card.src;
    img.onerror = () => {
      if (!img.dataset.retry) {
        img.dataset.retry = '1';
        img.src = IMG_DIR + encodeURIComponent(card.src);
      } else {
        el.style.outline = '2px dashed #f59e0b';
      }
    };

    el.appendChild(img);
    el.addEventListener('click', ()=> onCardClick(el));
    grid.appendChild(el);
  });
}
function scoreDelta(d){ state.score = Math.max(0, state.score + d); $('#score').textContent = state.score; }
function onCardClick(el){
  if(state.isTimeout || el.classList.contains('found')) return;
  const isTarget = el.dataset.target==='1';
  if(isTarget){
    playSfx('correct');
    el.classList.add('found');
    scoreDelta(CONFIG.pointsCorrect);
    checkLevelClear();
  }else{
    playSfx('wrong');
    el.animate([{transform:'translateY(0)'},{transform:'translateY(3px)'},{transform:'translateY(0)'}], {duration:120});
    scoreDelta(CONFIG.pointsWrong);
  }
}
function checkLevelClear(){
  const remain = [...grid.children].filter(c=>c.dataset.target==='1' && !c.classList.contains('found'));
  if(remain.length===0){
    const elapsed = Date.now() - state.startedAt;
    const leftMs  = Math.max(0, state.levelLimitMs - elapsed);
    const bonus   = Math.floor(leftMs/1000) * CONFIG.clearBonusPerSec;

    stopTimer();
    state.totalElapsedMs += Math.min(elapsed, state.levelLimitMs);
    if(bonus) scoreDelta(bonus);
    playSfx('clear');

    showResult({ title:'恭喜過關！', canNext:true, elapsedMs:elapsed, bonus });
  }
}

/* ========= 結果 / 超時 ========= */
function showResult({title, canNext, elapsedMs, bonus=0}){
  $('#rLevel').textContent = state.level;
  $('#rTotal').textContent = levelTotal;
  $('#rTime').textContent  = fmt(elapsedMs);
  $('#rScore').textContent = state.score;

  document.querySelector('#result .big').textContent = title;
  document.getElementById('btnNext').style.display = canNext ? 'inline-block' : 'none';

  if(bonus){
    const timeLine = document.getElementById('rTime').parentElement;
    timeLine.innerHTML = `本關用時 <b id="rTime">${fmt(elapsedMs)}</b>．獲得分數 <b id="rScore">${state.score}</b>（含剩餘秒數獎勵 +${bonus}）`;
  }

  document.getElementById('result').classList.remove('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  grid.classList.add('hidden');
}
function onTimeout(){
  showResult({ title:'時間到！', canNext:false, elapsedMs: state.levelLimitMs });
}

/* ========= 關卡控制 ========= */
function startLevel(n){
  if(n<1) n=1;
  if(n>levelTotal){ return showGameOver(); }

  document.getElementById('result').classList.add('hidden');
  document.getElementById('gameover').classList.add('hidden');
  document.getElementById('goalPanel').classList.remove('hidden');
  grid.classList.remove('hidden');

  state.isTimeout = false;
  document.getElementById('levelNow').textContent = String(n);

  state.level = n;
  const cfg = LEVELS[n-1];
  renderGoal(cfg);
  renderGrid(buildDeck(cfg));
  startCountdown(cfg.timeSec);
}
function nextLevel(){
  if(state.level >= levelTotal){ showGameOver(); }
  else { startLevel(state.level + 1); }
}
function showGameOver(){
  stopTimer();
  grid.classList.add('hidden');
  document.getElementById('goalPanel').classList.add('hidden');
  document.getElementById('gameover').classList.remove('hidden');
  document.getElementById('goTime').textContent = fmt(state.totalElapsedMs);
  document.getElementById('goScore').textContent = state.score;
}
function restartAll(){
  stopTimer();
  state = { level:1, score:0, timerId:null, levelLimitMs:0, startedAt:0, isTimeout:false, totalElapsedMs:0, sfxOn: state.sfxOn, bgmOn: state.bgmOn };
  document.getElementById('score').textContent = '0';
  document.getElementById('time').textContent  = '00:00';
  startLevel(1);
}

/* ========= 音效 UI 事件 ========= */
const btnSfx = document.getElementById('toggleSfx');
const btnBgm = document.getElementById('toggleBgm');
const volBgm = document.getElementById('bgmVol');

btnSfx.addEventListener('click', ()=>{
  state.sfxOn = !state.sfxOn;
  btnSfx.textContent = state.sfxOn ? '🔈 SFX：開' : '🔇 SFX：關';
});

btnBgm.addEventListener('click', async ()=>{
  state.bgmOn = !state.bgmOn;
  btnBgm.textContent = state.bgmOn ? '🎵 BGM：開' : '🎵 BGM：關';
  try{
    if(state.bgmOn){
      applyBgmVolume();
      await bgm.play();
    }else{
      bgm.pause();
    }
  }catch(e){
    console.warn('BGM play blocked until user gesture', e);
  }
});
volBgm.addEventListener('input', ()=>{
  VOL.bgm = parseFloat(volBgm.value || '0.4') / BASE_VOL.bgm; // 讓滑桿也影響 mixer 的 bgm 倍率
  saveVOL(); applyBgmVolume();
});

/* ========= Mixer 開關 & 綁定 ========= */
const mixer = document.getElementById('mixer');
const btnMixer = document.getElementById('btnMixer');
const btnCloseMixer = document.getElementById('btnCloseMixer');
const btnTestAll = document.getElementById('btnTestAll');
const btnResetVol = document.getElementById('btnResetVol');

const sliders = {
  master: document.getElementById('vol-master'),
  correct: document.getElementById('vol-correct'),
  wrong: document.getElementById('vol-wrong'),
  clear: document.getElementById('vol-clear'),
  tick: document.getElementById('vol-tick'),
  bgm: document.getElementById('vol-bgm'),
};
const pct = {
  master: document.getElementById('pct-master'),
  correct: document.getElementById('pct-correct'),
  wrong: document.getElementById('pct-wrong'),
  clear: document.getElementById('pct-clear'),
  tick: document.getElementById('pct-tick'),
  bgm: document.getElementById('pct-bgm'),
};
function fmtPct(v){ return Math.round(v*100) + '%'; }
function syncMixerUI(){
  for(const k of Object.keys(sliders)){
    sliders[k].value = VOL[k];
    pct[k].textContent = fmtPct(VOL[k]);
  }
}
function attachSlider(k){
  sliders[k].addEventListener('input', ()=>{
    VOL[k] = parseFloat(sliders[k].value || '1');
    pct[k].textContent = fmtPct(VOL[k]);
    saveVOL();
    if(k === 'bgm' || k === 'master') applyBgmVolume();
  });
}
Object.keys(sliders).forEach(attachSlider);

btnMixer.addEventListener('click', ()=>{ syncMixerUI(); mixer.classList.remove('hidden'); });
btnCloseMixer.addEventListener('click', ()=> mixer.classList.add('hidden'));
btnResetVol.addEventListener('click', ()=>{ VOL = { ...DEFAULT_VOL }; saveVOL(); syncMixerUI(); applyBgmVolume(); });

btnTestAll.addEventListener('click', ()=>{
  const order = ['correct','wrong','clear','tick'];
  let i = 0; const run = ()=>{ if(i>=order.length) return; playSfx(order[i++]); setTimeout(run, 500); }; run();
});
syncMixerUI();

/* ========= 其他事件 ========= */
document.getElementById('btnRestart').addEventListener('click', restartAll);
document.getElementById('btnNext').addEventListener('click', nextLevel);
document.getElementById('btnAgain').addEventListener('click', ()=> startLevel(state.level));
document.getElementById('btnRestart2').addEventListener('click', restartAll);

/* ========= 啟動 ========= */
startLevel(1);
</script>
</body>
</html>
